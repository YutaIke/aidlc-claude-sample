# backend ビジネスルール

## 概要

backend ユニットのビジネスルール、バリデーション、制約を定義します。

---

## 1. 認証ルール

### BR-AUTH-001: パスワードポリシー
- 最低6文字以上
- 最大100文字
- 文字種制限なし（英数字記号すべて許可）

### BR-AUTH-002: JWTトークン有効期限
- 有効期限: 24時間
- リフレッシュトークン: なし（再ログインが必要）

### BR-AUTH-003: 論理削除ユーザーのログイン
- isDeleted = true のユーザーはログイン不可
- エラーメッセージ: 「このアカウントは無効化されています」

---

## 2. ユーザー管理ルール

### BR-USER-001: ユーザー名ルール
- 必須
- 最低3文字、最大50文字
- 英数字とアンダースコアのみ許可
- 大文字小文字を区別しない（一意性チェック時）

### BR-USER-002: ロール種別
| ロール | 値 | 説明 |
|--------|-----|------|
| 一般従業員 | `employee` | アイデア提出、閲覧 |
| パネルメンバー | `panel_member` | 評価機能を追加で利用可能 |
| 管理者 | `admin` | 全機能利用可能 |

### BR-USER-003: ロール権限階層
```
admin > panel_member > employee
```
- 上位ロールは下位ロールの機能をすべて利用可能

### BR-USER-004: 論理削除ルール
- ユーザー削除は論理削除（isDeleted = true）
- 削除されたユーザーのデータ（アイデア、評価）は保持
- 削除されたユーザーは一覧に表示されない
- 削除されたユーザーのアイデアは引き続き表示される

---

## 3. アイデア管理ルール

### BR-IDEA-001: アイデアフィールド制約
| フィールド | 必須 | 最小 | 最大 | 備考 |
|-----------|------|------|------|------|
| title | ○ | 1文字 | 100文字 | - |
| description | ○ | 1文字 | 2000文字 | - |
| expectedEffect | ○ | 1文字 | 1000文字 | - |

### BR-IDEA-002: アイデアステータス
| ステータス | 値 | 説明 |
|-----------|-----|------|
| 下書き | `draft` | 編集・削除可能、非公開 |
| 提出済み | `submitted` | 編集・削除不可、公開 |

### BR-IDEA-003: ステータス遷移ルール
```
draft → submitted  ✓ 可能（提出操作）
submitted → draft  ✗ 不可（一度提出したら戻せない）
```

### BR-IDEA-004: アイデア編集権限
- 下書き状態のアイデアのみ編集可能
- 編集できるのは著者本人のみ

### BR-IDEA-005: アイデア削除権限
- 下書き状態のアイデアのみ削除可能
- 削除できるのは著者本人のみ
- 提出済みアイデアは削除不可

### BR-IDEA-006: アイデア閲覧権限
- 下書き: 著者本人のみ閲覧可能
- 提出済み: 全ユーザー閲覧可能

---

## 4. 画像管理ルール

### BR-IMAGE-001: 対応フォーマット
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)

### BR-IMAGE-002: ファイルサイズ制限
- 最大: 5MB per file

### BR-IMAGE-003: 画像数制限
- 1アイデアあたり最大5枚

### BR-IMAGE-004: 画像削除ルール
- アイデアが下書き状態の場合のみ削除可能
- アイデア削除時は関連画像も削除

---

## 5. 評価ルール

### BR-EVAL-001: 評価スコア範囲
- 各基準: 1〜10 の整数
- 小数は不可

### BR-EVAL-002: 評価基準
| 基準 | フィールド名 | 重み |
|------|-------------|------|
| 実現可能性 | feasibilityScore | 1/3 |
| インパクト | impactScore | 1/3 |
| 革新性 | innovationScore | 1/3 |

### BR-EVAL-003: 評価権限
- パネルメンバー（panel_member）または管理者（admin）のみ評価可能
- 一般従業員（employee）は評価不可

### BR-EVAL-004: 自己評価禁止
- 自分が提出したアイデアは評価不可

### BR-EVAL-005: 重複評価禁止
- 1人の評価者は1つのアイデアに対して1回のみ評価可能
- 評価の修正は不可（再評価不可）

### BR-EVAL-006: 評価対象
- 提出済み（submitted）のアイデアのみ評価可能
- 下書き（draft）のアイデアは評価不可

### BR-EVAL-007: フィードバックコメント
- 任意入力（空欄可）
- 最大1000文字

---

## 6. スコア計算ルール

### BR-SCORE-001: 最小評価数
- 最終スコア計算には最低3件の評価が必要
- 3件未満の場合、最終スコアは null（未確定）

### BR-SCORE-002: 最終スコア計算式
```
各基準の調整平均 = (Σスコア - 最高点 - 最低点) / (評価数 - 2)
最終スコア = (実現可能性調整平均 + インパクト調整平均 + 革新性調整平均) / 3
```

### BR-SCORE-003: スコア精度
- 小数点第2位で四捨五入
- 表示形式: X.XX

### BR-SCORE-004: 同点時の除外ルール
- 最高点が複数ある場合: 1件のみ除外
- 最低点が複数ある場合: 1件のみ除外

---

## 7. リーダーボードルール

### BR-LEAD-001: 表示対象
- 提出済み（submitted）かつ最終スコアが確定しているアイデアのみ

### BR-LEAD-002: ソート順
- 最終スコア降順（高い順）

### BR-LEAD-003: 同点時の順位
- 同点は同順位として表示
- 例: 1位、1位、3位、4位、4位、4位、7位...

### BR-LEAD-004: 更新タイミング
- 手動更新（管理者が「更新」ボタンを押した時）
- 自動更新なし

---

## 8. 表彰ルール

### BR-RECOG-001: 表彰対象
- リーダーボード上位3位までのアイデア
- 同点の場合、3位以内のアイデアすべてが表彰対象

### BR-RECOG-002: 表彰実行権限
- 管理者（admin）のみ実行可能

### BR-RECOG-003: 表彰の上書き
- 新しい表彰を実行すると、既存の表彰は削除される
- 履歴は保持されない（最新の表彰のみ有効）

### BR-RECOG-004: 通知
- 表彰されたアイデアの提出者にシステム内通知
- 通知はダッシュボードに表示

---

## 9. エラーコード一覧

### 認証エラー (AUTH)
| コード | メッセージ |
|--------|----------|
| AUTH_001 | ユーザー名またはパスワードが正しくありません |
| AUTH_002 | このアカウントは無効化されています |
| AUTH_003 | 認証トークンが必要です |
| AUTH_004 | 認証トークンが無効または期限切れです |

### ユーザーエラー (USER)
| コード | メッセージ |
|--------|----------|
| USER_001 | このユーザー名は既に使用されています |
| USER_002 | パスワードは6文字以上で入力してください |
| USER_003 | ユーザーが見つかりません |
| USER_004 | 無効なロールです |

### アイデアエラー (IDEA)
| コード | メッセージ |
|--------|----------|
| IDEA_001 | 入力内容に不備があります |
| IDEA_002 | アイデアが見つかりません |
| IDEA_003 | このアイデアを操作する権限がありません |
| IDEA_004 | 提出済みのアイデアは編集できません |
| IDEA_005 | 提出済みのアイデアは削除できません |
| IDEA_006 | このアイデアは既に提出されています |

### 評価エラー (EVAL)
| コード | メッセージ |
|--------|----------|
| EVAL_001 | アイデアが見つかりません |
| EVAL_002 | 下書き状態のアイデアは評価できません |
| EVAL_003 | 評価する権限がありません |
| EVAL_004 | 自分のアイデアは評価できません |
| EVAL_005 | このアイデアは既に評価済みです |
| EVAL_006 | スコアは1〜10の整数で入力してください |

### 画像エラー (IMAGE)
| コード | メッセージ |
|--------|----------|
| IMAGE_001 | 対応していないファイル形式です |
| IMAGE_002 | ファイルサイズが上限を超えています |
| IMAGE_003 | 画像の最大数に達しています |

---

*作成日: 2026-01-17*
