# backend ビジネスロジックモデル

## 概要

backend ユニットの主要なビジネスロジックとアルゴリズムを定義します。

---

## 1. 認証ロジック

### 1.1 ログイン処理

```
入力: username, password
処理:
  1. username でユーザーを検索
  2. ユーザーが存在しない場合 → エラー（AUTH_001）
  3. ユーザーが論理削除されている場合 → エラー（AUTH_002）
  4. パスワードをbcryptで検証
  5. パスワードが一致しない場合 → エラー（AUTH_001）
  6. JWTトークンを生成（ペイロード: userId, role, exp）
  7. トークンとユーザー情報を返却
出力: { token, user }
```

### 1.2 トークン検証処理

```
入力: Authorization ヘッダー (Bearer token)
処理:
  1. ヘッダーからトークンを抽出
  2. トークンが存在しない場合 → エラー（AUTH_003）
  3. JWTを検証（署名、有効期限）
  4. 検証失敗の場合 → エラー（AUTH_004）
  5. ペイロードからユーザーIDを取得
  6. ユーザーが存在し、削除されていないことを確認
  7. リクエストにユーザー情報を付与
出力: 認証済みリクエスト
```

---

## 2. ユーザー管理ロジック

### 2.1 ユーザー作成処理

```
入力: username, password, role
処理:
  1. username の重複チェック
  2. 重複する場合 → エラー（USER_001）
  3. パスワードバリデーション（最低6文字）
  4. バリデーション失敗 → エラー（USER_002）
  5. パスワードをbcryptでハッシュ化（saltRounds: 10）
  6. ユーザーを作成（isDeleted: false）
  7. 作成されたユーザーを返却（パスワード除く）
出力: User（パスワード除く）
```

### 2.2 ユーザー論理削除処理

```
入力: userId
処理:
  1. ユーザーの存在確認
  2. 存在しない場合 → エラー（USER_003）
  3. isDeleted フラグを true に設定
  4. 更新されたユーザーを返却
出力: User
```

### 2.3 ロール変更処理

```
入力: userId, newRole
処理:
  1. ユーザーの存在確認
  2. 存在しない場合 → エラー（USER_003）
  3. 有効なロール値か確認（employee, panel_member, admin）
  4. 無効な場合 → エラー（USER_004）
  5. ロールを更新
  6. 更新されたユーザーを返却
出力: User
```

---

## 3. アイデア管理ロジック

### 3.1 アイデア作成処理

```
入力: title, description, expectedEffect, status, authorId
処理:
  1. 必須フィールドのバリデーション
     - title: 必須、1-100文字
     - description: 必須、1-2000文字
     - expectedEffect: 必須、1-1000文字
  2. バリデーション失敗 → エラー（IDEA_001）
  3. status が 'draft' または 'submitted' か確認
  4. アイデアを作成
  5. 作成されたアイデアを返却
出力: Idea
```

### 3.2 アイデア更新処理

```
入力: ideaId, updateData, requestUserId
処理:
  1. アイデアの存在確認
  2. 存在しない場合 → エラー（IDEA_002）
  3. アイデアの著者が requestUserId と一致するか確認
  4. 一致しない場合 → エラー（IDEA_003）
  5. アイデアの status が 'draft' か確認
  6. 'submitted' の場合 → エラー（IDEA_004）
  7. フィールドバリデーション
  8. アイデアを更新
  9. 更新されたアイデアを返却
出力: Idea
```

### 3.3 アイデア削除処理

```
入力: ideaId, requestUserId
処理:
  1. アイデアの存在確認
  2. 存在しない場合 → エラー（IDEA_002）
  3. アイデアの著者が requestUserId と一致するか確認
  4. 一致しない場合 → エラー（IDEA_003）
  5. アイデアの status が 'draft' か確認
  6. 'submitted' の場合 → エラー（IDEA_005）
  7. 関連する画像を削除
  8. アイデアを削除
出力: void
```

### 3.4 下書き提出処理

```
入力: ideaId, requestUserId
処理:
  1. アイデアの存在確認
  2. 存在しない場合 → エラー（IDEA_002）
  3. アイデアの著者が requestUserId と一致するか確認
  4. 一致しない場合 → エラー（IDEA_003）
  5. アイデアの status が 'draft' か確認
  6. 'submitted' の場合 → エラー（IDEA_006）
  7. status を 'submitted' に更新
  8. 更新されたアイデアを返却
出力: Idea
```

---

## 4. 評価ロジック

### 4.1 評価登録処理

```
入力: ideaId, evaluatorId, feasibilityScore, impactScore, innovationScore, comment
処理:
  1. アイデアの存在確認
  2. 存在しない場合 → エラー（EVAL_001）
  3. アイデアの status が 'submitted' か確認
  4. 'draft' の場合 → エラー（EVAL_002）
  5. 評価者がパネルメンバーまたは管理者か確認
  6. 権限がない場合 → エラー（EVAL_003）
  7. 自分のアイデアを評価しようとしていないか確認
  8. 自己評価の場合 → エラー（EVAL_004）
  9. 既に評価済みかチェック
  10. 評価済みの場合 → エラー（EVAL_005）
  11. スコアバリデーション（各スコア: 1-10の整数）
  12. バリデーション失敗 → エラー（EVAL_006）
  13. 評価を作成
  14. 作成された評価を返却
出力: Evaluation
```

### 4.2 最終スコア計算アルゴリズム

```
入力: ideaId
処理:
  1. アイデアの全評価を取得
  2. 評価数が3未満の場合 → null を返却
  3. 各基準ごとに計算:
     a. feasibilityScores = 全評価のfeasibilityScore配列
     b. 最高点と最低点を除外
     c. 残りの平均を計算 → feasibilityAvg
     d. impactScores, innovationScores も同様に計算
  4. 最終スコア = (feasibilityAvg + impactAvg + innovationAvg) / 3
  5. 小数点第2位で四捨五入
出力: number | null

例:
  評価: [
    { feasibility: 8, impact: 7, innovation: 9 },
    { feasibility: 6, impact: 8, innovation: 7 },
    { feasibility: 9, impact: 6, innovation: 8 },
    { feasibility: 7, impact: 9, innovation: 6 }
  ]

  feasibility: [8, 6, 9, 7] → 除外後 [8, 7] → 平均 7.5
  impact: [7, 8, 6, 9] → 除外後 [7, 8] → 平均 7.5
  innovation: [9, 7, 8, 6] → 除外後 [7, 8] → 平均 7.5

  最終スコア = (7.5 + 7.5 + 7.5) / 3 = 7.5
```

---

## 5. ダッシュボード・リーダーボードロジック

### 5.1 リーダーボード生成アルゴリズム

```
入力: なし
処理:
  1. status = 'submitted' の全アイデアを取得
  2. 各アイデアの最終スコアを計算
  3. スコアがnullのアイデアはリストから除外
  4. スコア降順でソート
  5. ランク付け（同点は同順位）:
     - 前のアイデアと同じスコア → 同じランク
     - 異なるスコア → 現在の位置のランク
  6. 表彰情報を付与（Recognition テーブル参照）
  7. リーダーボードエントリを返却
出力: LeaderboardEntry[]

ランク付け例:
  ソート後: [8.5, 8.5, 7.0, 6.5, 6.5, 6.5]
  ランク:   [1,   1,   3,   4,   4,   4  ]
```

### 5.2 統計情報計算処理

```
入力: なし
処理:
  1. 総アイデア数 = status='submitted' のアイデア数
  2. 総評価数 = 全評価レコード数
  3. 総ユーザー数 = isDeleted=false のユーザー数
  4. 平均スコア = 全アイデアの最終スコアの平均（nullを除く）
出力: DashboardStatistics
```

---

## 6. 表彰ロジック

### 6.1 表彰実行処理

```
入力: なし（管理者が実行）
処理:
  1. リーダーボードを取得
  2. 上位3位までのアイデアを抽出（同点考慮）
     - ランク1, 2, 3 のアイデアをすべて取得
  3. 既存の表彰レコードを削除
  4. 新しい表彰レコードを作成
  5. 表彰されたアイデアの提出者に通知を生成
  6. 表彰結果を返却
出力: Recognition[]

同点時の例:
  ランク: [1, 1, 3, 4, ...]
  表彰対象: ランク1（2件）+ ランク3（1件）= 3件
```

---

*作成日: 2026-01-17*
